# üîç Watermark Detection Integration

## Overview

TruthSnapBot —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **FraudLens API** –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ AI watermarks —á–µ—Ä–µ–∑:
- **OCR —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–µ—Ç–æ–∫** (Tesseract) - "Generated by AI", "DALL-E", "Gemini" –∏ —Ç.–¥.
- **–ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ watermarks** (SynthID, C2PA, Adobe)
- **–í–∏–∑—É–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã** (—Ü–≤–µ—Ç–Ω—ã–µ –∫–≤–∞–¥—Ä–∞—Ç—ã DALL-E, –ª–æ–≥–æ—Ç–∏–ø—ã)
- **üÜï Priority-based fraud detection** - High EXIF fraud scores (‚â•80) now trigger early exit with high confidence (80-98%)

> **‚ö†Ô∏è –í–ê–ñ–ù–û**: –° –≤–µ—Ä—Å–∏–∏ 2024-01-16 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å confidence discrepancy (68% ‚Üí 90%+). –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ [CONFIDENCE_FIX.md](CONFIDENCE_FIX.md)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Telegram Bot
    ‚Üì
FraudLens API (/api/v1/verify)
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Watermark Detection Pipeline   ‚îÇ
‚îÇ  1. Visual OCR (Tesseract)      ‚îÇ
‚îÇ  2. Content Credentials (C2PA)  ‚îÇ
‚îÇ  3. SynthID (Google)            ‚îÇ
‚îÇ  4. Adobe/Microsoft watermarks  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
TruthSnapBot (WatermarkDetector)
    ‚Üì
User Result
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. FraudLens API (`/api/v1/consumer/verify`)

**Endpoint**: `POST /api/v1/consumer/verify`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
```json
{
  "image": "<binary>",
  "detail_level": "basic" | "detailed",
  "preserve_exif": true | false
}
```

**–û—Ç–≤–µ—Ç**:
```json
{
  "verdict": "ai_generated" | "real" | "manipulated",
  "confidence": 0.95,
  "watermark_detected": true,
  "watermark_analysis": {
    "type": "Google Gemini/Imagen",
    "confidence": 0.90,
    "method": "ocr_text_detection",
    "text_found": "made with google ai",
    "location": "bottom_right",
    "metadata": {}
  }
}
```

**–î–µ—Ç–µ–∫—Ü–∏—è –º–µ—Ç–æ–¥—ã**:
1. **OCR** - —Å–∫–∞–Ω–∏—Ä—É–µ—Ç —É–≥–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ watermarks
2. **C2PA** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –ø–æ–¥–ø–∏—Å–∏
3. **SynthID** - –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –Ω–µ–≤–∏–¥–∏–º—ã–µ watermarks Google
4. **Visual Patterns** - —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –ª–æ–≥–æ—Ç–∏–ø—ã –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

---

### 2. TruthSnapBot Integration

#### `fraudlens_client.py`

```python
# –í—ã–∑–æ–≤ FraudLens API
result = await fraudlens.verify_photo(
    image_bytes=photo_bytes,
    detail_level="detailed",
    preserve_exif=True
)

# result —Å–æ–¥–µ—Ä–∂–∏—Ç watermark_analysis
if result['watermark_detected']:
    print(f"Watermark: {result['watermark_analysis']['type']}")
```

#### `watermark_detector.py`

```python
# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ watermark –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ FraudLens —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
detector = WatermarkDetector()

watermark_info = await detector.detect(
    image_bytes=image_bytes,
    fraudlens_result=result  # –ü–µ—Ä–µ–¥–∞—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç FraudLens
)

# watermark_info —Å–æ–¥–µ—Ä–∂–∏—Ç:
# - detected: bool
# - type: "ocr" | "synthid" | "c2pa" | "adobe"
# - confidence: float
# - text_found: str (–¥–ª—è OCR)
# - location: str (–≥–¥–µ –Ω–∞–π–¥–µ–Ω watermark)
# - method: str (–º–µ—Ç–æ–¥ –¥–µ—Ç–µ–∫—Ü–∏–∏)
```

---

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ Watermarks

### OCR –¢–µ–∫—Å—Ç–æ–≤—ã–µ Watermarks

FraudLens —Å–∫–∞–Ω–∏—Ä—É–µ—Ç 4 —É–≥–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Ç–µ–∫—Å—Ç:
- **Google Gemini/Imagen**: "made with google ai", "gemini", "imagen"
- **DALL-E/OpenAI**: "dall-e", "dall¬∑e", "openai", "chatgpt"
- **Midjourney**: "midjourney", "mj", "/imagine"
- **Stable Diffusion**: "stable diffusion", "stability ai"
- **Generic**: "ai generated", "ai image", "synthetic"

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**:
```json
{
  "detected": true,
  "type": "Google Gemini/Imagen",
  "confidence": 0.90,
  "text_found": "made with google ai",
  "location": "bottom_right",
  "method": "ocr_text_detection"
}
```

### –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ Watermarks

- **C2PA** (Content Credentials) - 100% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
- **SynthID** (Google) - 95% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
- **Adobe Content Credentials** - 95% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
- **Microsoft Designer** - 95% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**:
```json
{
  "detected": true,
  "type": "SynthID",
  "confidence": 0.98,
  "method": "cryptographic_signature"
}
```

### –í–∏–∑—É–∞–ª—å–Ω—ã–µ –ü–∞—Ç—Ç–µ—Ä–Ω—ã

- **DALL-E —Ü–≤–µ—Ç–Ω—ã–µ –∫–≤–∞–¥—Ä–∞—Ç—ã** (–≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É)
- **Gemini "G" –ª–æ–≥–æ—Ç–∏–ø**
- **Midjourney —Å–µ—Ç–∫–∞**

---

## Workflow –≤ TruthSnapBot

### 1. –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

```python
# bot/handlers/photo.py
@router.message(F.photo)
async def handle_photo(message: Message):
    # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –≤ S3
    photo_s3_key = await storage.upload(photo_bytes)

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å
    job = queue.enqueue(
        analyze_photo_task,
        user_id=user.id,
        photo_s3_key=photo_s3_key,
        tier="photo"  # –∏–ª–∏ "document" –¥–ª—è EXIF
    )
```

### 2. Worker –∑–∞–ø—É—Å–∫–∞–µ—Ç –∞–Ω–∞–ª–∏–∑

```python
# workers/tasks.py
def analyze_photo_task(user_id, photo_s3_key, tier):
    # 1. –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ –∏–∑ S3
    photo_bytes = await s3.download(photo_s3_key)

    # 2. –í—ã–∑–≤–∞—Ç—å FraudLens API
    result = await fraudlens.verify_photo(
        photo_bytes,
        detail_level="detailed",
        preserve_exif=(tier == "document")
    )

    # result –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç watermark_analysis!

    # 3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ DB
    await analysis_repo.create_analysis(
        user_id=user_id,
        verdict=result['verdict'],
        confidence=result['confidence'],
        full_result=result  # –°–æ–¥–µ—Ä–∂–∏—Ç watermark_analysis
    )

    # 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await notifier.send_analysis_result(
        chat_id=chat_id,
        result=result
    )
```

### 3. –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

```
üì∏ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω

üî¥ AI-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: 95%

üîç –î–µ—Ç–∞–ª–∏:
‚Ä¢ –û–±–Ω–∞—Ä—É–∂–µ–Ω watermark: Google Gemini
‚Ä¢ –ú–µ—Ç–æ–¥: OCR —Ç–µ–∫—Å—Ç –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É
‚Ä¢ –ù–∞–π–¥–µ–Ω–æ: "made with google ai"

‚ö†Ô∏è –≠—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ –ò–ò
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç (Full Integration)

```bash
# –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ FraudLens API
python test_watermark_integration.py test_data/gemini_image.jpg

# –¢–µ—Å—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
python test_watermark_integration.py test_data/*.jpg
```

### –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç OCR –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞

```bash
# –¢–µ—Å—Ç OCR watermark –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –Ω–∞–ø—Ä—è–º—É—é
python test_ocr_simple.py test_data/gemini_image.png

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# üì∏ Testing OCR Watermark Detection
# Image: test_data/gemini_image.png
#
# üß™ Testing Visual Watermark Detector
# ================================================================================
# ‚úÖ Visual Watermark Detection Result:
#    Has Watermark: True
#    Confidence: 90.00%
#    Type: Google Gemini/Imagen
#    Method: ocr_text_detection
#    Text Found: 'made with google ai'
#    Location: bottom_right
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞**:
```
üß™ Testing watermark detection for: test_data/gemini_image.jpg
================================================================================
‚úÖ Image loaded: 234523 bytes

üì° STEP 1: Calling FraudLens API...
‚úÖ FraudLens API Response:
   Verdict: ai_generated
   Confidence: 95.00%
   Watermark Detected: True
   Processing Time: 1234ms

üîç Watermark Analysis:
   Type: Google Gemini/Imagen
   Confidence: 90.00%
   Method: ocr_text_detection
   Text Found: 'made with google ai'
   Location: bottom_right

üì¶ STEP 2: Extracting watermark info via WatermarkDetector...
‚úÖ Watermark Info Extracted:
   Detected: True
   Type: Google Gemini/Imagen
   Confidence: 90.00%
   Text Found: 'made with google ai'
   Location: bottom_right
   Detection Method: ocr_text_detection

================================================================================
üìä SUMMARY:
‚úÖ AI Watermark DETECTED via ocr_text_detection
   Generator: Google Gemini/Imagen
   Confidence: 90.00%
   OCR Text: 'made with google ai'
================================================================================
```

### Unit Tests

```bash
cd truthsnap-bot
pytest tests/test_watermark_detector.py -v
```

---

## FraudLens API Configuration

### Environment Variables

```bash
# .env
FRAUDLENS_API_URL=http://localhost:8000
FRAUDLENS_API_TIMEOUT=60
```

### Docker Compose

```yaml
services:
  fraudlens-api:
    build: ./fraudlens
    ports:
      - "8000:8000"
    environment:
      - TESSERACT_ENABLED=true  # –í–∫–ª—é—á–∏—Ç—å OCR watermark detection
```

---

## Performance

### –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

| –ú–µ—Ç–æ–¥ –¥–µ—Ç–µ–∫—Ü–∏–∏ | –í—Ä–µ–º—è |
|----------------|-------|
| OCR (Tesseract) | ~500-1000ms |
| C2PA –ø—Ä–æ–≤–µ—Ä–∫–∞ | ~100ms |
| SynthID | ~200ms |
| Visual Patterns | ~300ms |
| **–û–±—â–µ–µ** | **~1-2s** |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

1. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è** - –≤—Å–µ –º–µ—Ç–æ–¥—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. **Early exit** - –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–º watermark –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - FraudLens –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

---

## Error Handling

### Fallback –º–µ—Ö–∞–Ω–∏–∑–º

–ï—Å–ª–∏ FraudLens API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:
```python
# WatermarkDetector –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ stub –¥–µ—Ç–µ–∫—Ç–æ—Ä—ã
watermark_info = await detector.detect(image_bytes)

# –†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
# {"detected": False, "type": "none", "confidence": 0.0}
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
logger.info(f"üîç OCR watermark detection started")
logger.info(f"‚úÖ Watermark found: {watermark_type}")
logger.warning(f"‚ö†Ô∏è OCR failed for corner: {error}")
```

---

## FAQ

### Q: –ö–∞–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è?
**A**: JPEG, PNG, HEIC, WebP

### Q: –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –¥–µ—Ç–µ–∫—Ü–∏—è –Ω–∞ —Å–∂–∞—Ç—ã—Ö Telegram —Ñ–æ—Ç–æ?
**A**: –î–∞, –Ω–æ —Å –º–µ–Ω—å—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é. –î–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ **–¥–æ–∫—É–º–µ–Ω—Ç** (preserve_exif=True)

### Q: –ß—Ç–æ –µ—Å–ª–∏ watermark –±—ã–ª —É–¥–∞–ª—ë–Ω?
**A**: OCR watermarks –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **intrinsic detection** –∏ **AI models** –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.

### Q: –ú–æ–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ watermark –ø–∞—Ç—Ç–µ—Ä–Ω—ã?
**A**: –î–∞! –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ `FraudLensAI/backend/integrations/visual_watermark_detector.py`:
```python
self.ai_watermark_texts = [
    'my custom watermark',
    # ... existing watermarks
]
```

---

## References

- **FraudLens API Spec**: `/fraudlens-api-spec.yaml`
- **Visual Watermark Detector**: `/FraudLensAI/backend/integrations/visual_watermark_detector.py`
- **Content Credentials**: `/FraudLensAI/backend/integrations/content_credentials.py`
- **Client Integration**: `/truthsnap-bot/app/services/fraudlens_client.py`

---

**–°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è –±–æ—Ä—å–±—ã —Å deepfake blackmail**
